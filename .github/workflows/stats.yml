name: Generate GitHub Stats + Languages Graph

on:
  schedule:
    - cron: "0 */6 * * *"  # every 2 hours
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # --- GitHub Stats Card ---
      - name: Download GitHub Stats card
        run: |
          curl -L \
          "https://github-readme-stats.vercel.app/api?username=snarelord&theme=tokyonight&show_icons=true&count_private=true&hide_border=true&include_all_commits=true" \
          -o github-stats.svg

      # --- GitHub Streak Card ---
      - name: Download GitHub Streak card
        run: |
          curl -L \
          "https://streak-stats.demolab.com?user=snarelord&theme=tokyonight&hide_border=true&border_radius=8" \
          -o github-streak.svg

      # --- Setup Node for language graph ---
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      # --- Generate Languages Bar Chart ---
      - name: Generate languages bar graph (TokyoNight style)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USERNAME: snarelord
        run: |
          cat > generate-langs.mjs <<'NODE'
          import fs from 'fs';

          const token = process.env.GITHUB_TOKEN;
          const user = process.env.USERNAME || "snarelord";

          const headers = {
            Authorization: `Bearer ${token}`,
            Accept: "application/vnd.github+json",
            "User-Agent": "github-stats-action"
          };

          async function fetchRepos() {
            let page = 1;
            let all = [];
            while (true) {
              const res = await fetch(`https://api.github.com/users/${user}/repos?per_page=100&page=${page}`, { headers });
              const data = await res.json();
              if (!data || data.length === 0) break;
              all = all.concat(data);
              page++;
            }
            return all;
          }

          async function fetchLanguages(repos) {
            const totals = {};
            for (const repo of repos) {
              try {
                const res = await fetch(repo.languages_url, { headers });
                const langs = await res.json();
                for (const [k, v] of Object.entries(langs)) {
                  totals[k] = (totals[k] || 0) + v;
                }
              } catch {}
            }
            return totals;
          }

          function tokyoColors(i) {
            const palette = [
              "#7aa2f7", "#bb9af7", "#9ece6a",
              "#e0af68", "#f7768e", "#7dcfff",
              "#c0caf5"
            ];
            return palette[i % palette.length];
          }

          function generateBarGraph(langMap) {
            const entries = Object.entries(langMap)
              .sort((a,b) => b[1]-a[1])
              .slice(0, 6);

            const total = entries.reduce((sum, [,v]) => sum+v, 0);
            const width = 480;
            const barW = 300;
            const barH = 18;

            let y = 50;
            let bars = "";
            let labels = "";

            entries.forEach(([lang, bytes], i) => {
              const pct = total === 0 ? 0 : (bytes / total) * 100;
              const w = (pct / 100) * barW;
              const color = tokyoColors(i);

              bars += `
                <rect x="150" y="${y}" width="${w}" height="${barH}" fill="${color}" rx="4" />
              `;
              labels += `
                <text x="150" y="${y - 4}" fill="#c0caf5" font-size="13">${lang} â€” ${pct.toFixed(1)}%</text>
              `;
              y += 40;
            });

            return `
            <svg width="${width}" height="${y+20}" viewBox="0 0 ${width} ${y+20}" xmlns="http://www.w3.org/2000/svg">
              <style>
                text { font-family: Inter, Arial, sans-serif; }
              </style>
              
              <rect width="100%" height="100%" fill="#1a1b26" rx="8"/>
              <text x="20" y="30" font-size="18" fill="#c0caf5">Top Languages</text>
              ${labels}
              ${bars}
            </svg>
            `;
          }

          (async () => {
            const repos = await fetchRepos();
            const languages = await fetchLanguages(repos);
            const svg = generateBarGraph(languages);
            fs.writeFileSync("top-langs.svg", svg, "utf8");
          })();
          NODE

          node generate-langs.mjs

      # --- Commit results ---
      - name: Commit changes
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Action"
          git add github-stats.svg github-streak.svg top-langs.svg || true
          git commit -m "Update GitHub stats & language graph" || true
          git push || true
